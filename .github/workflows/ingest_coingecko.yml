name: Ingest CoinGecko
on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: cp .env.example .env
      - run: python -m certus.ingestion.ingest_coingecko --symbols BTC,ETH,SOL --vs USD --top 50 --dest duckdb,parquet
        env:
          # Provide both the historical secret name (CG_API_KEY) and the
          # canonical name used by the code (COINGECKO_API_KEY) so workflows
          # remain compatible with existing repo secrets.
          COINGECKO_API_KEY: ${{ secrets.CG_API_KEY }}
          CG_API_KEY: ${{ secrets.CG_API_KEY }}
          CG_BASE_URL: ${{ secrets.CG_BASE_URL }}
      - name: Commit data artifacts
        run: |
          git config user.name "certus-bot"
          git config user.email "certus@example.com"
          git add data/*.parquet data/certus.duckdb || true
          git commit -m "data: update cg quotes" || echo "no changes"
          git push || true
